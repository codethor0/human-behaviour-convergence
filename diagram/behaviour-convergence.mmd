%% Architecture Diagram - Code-Derived (Iteration N+9)
%% Generated: 2025-12-22
%% Source: Direct code analysis from app/backend/app/main.py and routers

%%{ init: {
  "fontFamily": "Inter, Roboto, Helvetica, Arial, sans-serif",
  "fontSize": "14px",
  "theme": "base",
  "themeVariables": {
    "primaryColor": "#ffffff",
    "primaryTextColor": "#1a1a1a",
    "primaryBorderColor": "#d0d0d0",
    "lineColor": "#666666",
    "secondaryColor": "#f5f7fa",
    "tertiaryColor": "#eef2f6"
  },
  "flowchart": {
    "nodeSpacing": 80,
    "rankSpacing": 140,
    "curve": "basis",
    "padding": 30,
    "useMaxWidth": true
  }
} }%%

flowchart TB
    %% ================================================================
    %% CLIENT LAYER
    %% ================================================================
    subgraph CLIENT["Client Layer"]
        WEB["Next.js Frontend<br/>(index, forecast, playground, live)"]
        API_CLIENT["API Clients<br/>(REST)"]
    end

    %% ================================================================
    %% API LAYER
    %% ================================================================
    subgraph API["FastAPI Application<br/>(app/backend/app/main.py)"]
        FASTAPI["FastAPI App<br/>CORS + GZip Middleware"]

        subgraph ROUTERS["Routers"]
            PUBLIC_ROUTER["Public Router<br/>/api/public"]
            FORECAST_ROUTER["Forecasting Router<br/>/api/forecasting"]
            LIVE_ROUTER["Live Router<br/>/api/live"]
            PLAYGROUND_ROUTER["Playground Router<br/>/api/playground"]
            MAIN_ENDPOINTS["Core Endpoints<br/>/api/forecast, /health, /api/visual/*"]
        end

        CACHE["Thread-Safe Cache<br/>(CSV files, 5min TTL)"]
        BG_THREAD["Background Thread<br/>(Live monitoring refresh)"]
    end

    %% ================================================================
    %% CORE SERVICES
    %% ================================================================
    subgraph CORE["Core Services<br/>(app/core/)"]
        BEHAVIOR_INDEX["BehaviorIndexComputer<br/>(Stateless)"]
        FORECASTER["BehavioralForecaster<br/>(Stateless)"]
        LIVE_MONITOR["LiveMonitor<br/>(Stateful: snapshots)"]
        PLAYGROUND_SVC["Playground Service<br/>(Stateless)"]
        EXPLANATIONS["Explanation Generator<br/>(Stateless)"]
    end

    %% ================================================================
    %% DATA CONNECTORS
    %% ================================================================
    subgraph CONNECTORS["Data Connectors<br/>(connectors/)"]
        FIRMS["FIRMSFiresSync<br/>(NASA FIRMS API)"]
        OSM["OSMChangesetsSync<br/>(OpenStreetMap)"]
        WIKI["WikiPageviewsSync<br/>(Wikimedia)"]
    end

    %% ================================================================
    %% EXTERNAL DATA SOURCES
    %% ================================================================
    subgraph EXTERNAL["External Data Sources"]
        FIRMS_API["NASA FIRMS API<br/>(Fire data)"]
        OSM_API["OpenStreetMap<br/>(Changesets)"]
        WIKI_API["Wikimedia<br/>(Pageviews)"]
    end

    %% ================================================================
    %% STORAGE
    %% ================================================================
    subgraph STORAGE["Storage"]
        CSV_FILES["CSV Files<br/>(results/forecasts.csv, metrics.csv)"]
        DB["SQLite Database<br/>(ForecastDB)"]
        DATA_DIR["Public Data<br/>(data/public/)"]
    end

    %% ================================================================
    %% EDGES - CLIENT TO API
    %% ================================================================
    WEB --> API_CLIENT
    API_CLIENT --> FASTAPI

    %% ================================================================
    %% EDGES - API ROUTING
    %% ================================================================
    FASTAPI --> ROUTERS
    FASTAPI --> MAIN_ENDPOINTS
    FASTAPI --> CACHE
    FASTAPI --> BG_THREAD

    PUBLIC_ROUTER --> CONNECTORS
    FORECAST_ROUTER --> CORE
    LIVE_ROUTER --> LIVE_MONITOR
    PLAYGROUND_ROUTER --> PLAYGROUND_SVC
    MAIN_ENDPOINTS --> BEHAVIOR_INDEX
    MAIN_ENDPOINTS --> FORECASTER
    MAIN_ENDPOINTS --> EXPLANATIONS

    %% ================================================================
    %% EDGES - CORE SERVICES
    %% ================================================================
    BEHAVIOR_INDEX --> CONNECTORS
    FORECASTER --> BEHAVIOR_INDEX
    LIVE_MONITOR --> BEHAVIOR_INDEX
    LIVE_MONITOR --> CONNECTORS
    PLAYGROUND_SVC --> FORECASTER
    PLAYGROUND_SVC --> BEHAVIOR_INDEX

    %% ================================================================
    %% EDGES - CONNECTORS TO EXTERNAL
    %% ================================================================
    FIRMS --> FIRMS_API
    OSM --> OSM_API
    WIKI --> WIKI_API

    %% ================================================================
    %% EDGES - STORAGE
    %% ================================================================
    CACHE --> CSV_FILES
    FORECASTER --> DB
    CONNECTORS --> DATA_DIR
    LIVE_MONITOR --> DB

    %% ================================================================
    %% STYLES
    %% ================================================================
    classDef client fill:#e3f2fd,stroke:#90caf9,stroke-width:2px,color:#0d47a1
    classDef api fill:#fff3e0,stroke:#ffb74d,stroke-width:2px,color:#e65100
    classDef core fill:#e8f5e9,stroke:#81c784,stroke-width:2px,color:#2e7d32
    classDef connector fill:#f3e5f5,stroke:#ba68c8,stroke-width:2px,color:#4a148c
    classDef external fill:#fafafa,stroke:#bdbdbd,stroke-width:2px,color:#424242
    classDef storage fill:#e0f2f1,stroke:#4db6ac,stroke-width:2px,color:#004d40

    class WEB,API_CLIENT client
    class FASTAPI,ROUTERS,PUBLIC_ROUTER,FORECAST_ROUTER,LIVE_ROUTER,PLAYGROUND_ROUTER,MAIN_ENDPOINTS,CACHE,BG_THREAD api
    class BEHAVIOR_INDEX,FORECASTER,LIVE_MONITOR,PLAYGROUND_SVC,EXPLANATIONS core
    class FIRMS,OSM,WIKI connector
    class FIRMS_API,OSM_API,WIKI_API external
    class CSV_FILES,DB,DATA_DIR storage

# SPDX-License-Identifier: MIT-0
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch: {}

# Cancel in-progress runs for the same workflow on PR updates
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DISK_CAP_GB: 10
  MAX_LOG_MB: 5

jobs:
  lint-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            app/backend/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/backend/requirements.txt
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install black ruff

      - name: Ruff Lint
        run: ruff check app/ connectors/ tests/ hbc/ --exclude="notebooks|\.venv|\.git"

      - name: Black Format
        run: black --check app/ connectors/ tests/ hbc/ --exclude="notebooks|\.venv|\.git"

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            app/backend/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/backend/requirements.txt
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install mypy

      - name: Mypy Type Check
        run: mypy app/ connectors/ hbc/ --ignore-missing-imports || true
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            app/backend/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/backend/requirements.txt
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install semgrep

      - name: Semgrep Security Scan
        run: semgrep --config=auto app/ connectors/ tests/ hbc/

  sbom-scan:
    name: SBOM & CVE Scan
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

      - name: Generate SBOM
        run: |
          pip install syft
          syft dir:. -o json > sbom.json || echo "Warning: SBOM generation failed, continuing..."
          if [ -f "sbom.json" ]; then
            echo "SBOM size: $(du -h sbom.json | cut -f1)"
          else
            echo "SBOM file not generated, creating empty file for downstream steps"
            echo '{}' > sbom.json
          fi

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: CVE Scan
        run: |
          if [ -f "sbom.json" ] && [ -s "sbom.json" ] && [ "$(cat sbom.json)" != "{}" ]; then
            grype sbom:sbom.json -o table > cve-report.txt || echo "Warning: CVE scan failed, continuing..."
          else
            echo "Skipping CVE scan: SBOM file is missing or empty" > cve-report.txt
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cve-${{ github.run_number }}
          path: |
            sbom.json
            cve-report.txt
          retention-days: 30
          if-no-files-found: warn
          compression-level: 6

      - name: Post-cleanup
        if: always()
        run: |
          rm -f sbom.json cve-report.txt
          echo "=== Final Disk Usage ==="
          df -h | head -2

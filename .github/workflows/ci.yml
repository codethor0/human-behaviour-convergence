# SPDX-License-Identifier: MIT-0
name: CI

on:
  push:
    branches: [main, master]
    paths:
      - '**.py'
      - 'tests/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main, master]
    paths:
      - '**.py'
      - 'tests/**'
      - 'requirements*.txt'
      - 'pyproject.toml'
      - '.github/workflows/ci.yml'
  workflow_dispatch: {}

# Cancel in-progress runs for the same workflow on PR updates
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  DISK_CAP_GB: 10
  MAX_LOG_MB: 5

jobs:
  lint-format:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            app/backend/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/backend/requirements.txt
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install black ruff

      - name: Ruff Lint
        run: ruff check app/backend tests hbc --ignore F401,F402,F403,F405,F841,E402

      - name: Black Format
        run: black --check app/backend tests hbc

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            app/backend/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/backend/requirements.txt
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install mypy

      - name: Mypy Type Check
        run: mypy --strict app/backend tests hbc
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            app/backend/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/backend/requirements.txt
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          pip install semgrep

      - name: Semgrep Security Scan
        run: semgrep --config=auto app/backend tests hbc

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            app/backend/requirements.txt

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/backend/requirements.txt
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Tests
        run: pytest --maxfail=1 --disable-warnings tests -v -n auto

      - name: Post-cleanup test artifacts
        if: always()
        run: |
          echo "=== Post-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
          find . -type f -name ".coverage.*" -delete 2>/dev/null || true

  sbom-scan:
    name: SBOM & CVE Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pre-cleanup disk
        run: |
          echo "=== Pre-cleanup Disk Usage ==="
          df -h | head -2
          find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true

      - name: Generate SBOM
        run: |
          pip install syft
          syft dir:. -o json > sbom.json
          echo "SBOM size: $(du -h sbom.json | cut -f1)"

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: CVE Scan
        run: grype sbom:sbom.json -o table > cve-report.txt || true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cve-${{ github.run_number }}
          path: |
            sbom.json
            cve-report.txt
          retention-days: 30
          if-no-files-found: warn
          compression-level: 6

      - name: Post-cleanup
        if: always()
        run: |
          rm -f sbom.json cve-report.txt
          echo "=== Final Disk Usage ==="
          df -h | head -2

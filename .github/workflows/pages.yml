# SPDX-License-Identifier: PROPRIETARY
name: Deploy GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'diagram/**'
      - '.github/workflows/pages.yml'
      - 'index.html'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  render-diagram:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install mermaid-cli
        run: npm install -g @mermaid-js/mermaid-cli@10.9.1

      - name: Render SVG
        continue-on-error: true
        run: |
          mmdc -i diagram/behaviour-convergence.mmd -o diagram/behaviour-convergence.svg -p .github/puppeteer.config.cjs || true
          if [ ! -f "diagram/behaviour-convergence.svg" ]; then
            echo "[WARN] SVG file not generated, skipping"
          else
            echo "[PASS] SVG generated successfully"
          fi

      - name: Render PNG
        continue-on-error: true
        run: |
          mmdc -i diagram/behaviour-convergence.mmd -o diagram/behaviour-convergence.png -p .github/puppeteer.config.cjs -b transparent -s 2 || true
          if [ ! -f "diagram/behaviour-convergence.png" ]; then
            echo "[WARN] PNG file not generated, skipping"
          else
            echo "[PASS] PNG generated successfully"
          fi

      - name: Upload artifacts (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: rendered-diagram
          path: |
            diagram/behaviour-convergence.svg
            diagram/behaviour-convergence.png
          retention-days: 1

      - name: Create update PR if outputs changed (push only)
        if: ${{ github.event_name == 'push' }}
        continue-on-error: true
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(diagram): update rendered assets"
          title: "chore(diagram): update rendered assets"
          body: |
            Auto-generated by CI after changes to `diagram/behaviour-convergence.mmd`.
            Do not edit `diagram/*.svg` or `diagram/*.png` by hand; they are build artifacts.
          branch: ci/update-diagram
          branch-suffix: short-commit-hash
          add-paths: |
            diagram/behaviour-convergence.svg
            diagram/behaviour-convergence.png

  build:
    needs: render-diagram
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        continue-on-error: true
        uses: actions/configure-pages@v5

      - name: Prepare site
        run: |
          mkdir -p out
          cp -R docs out/
          cp -R diagram out/
          cp index.html out/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: out
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    continue-on-error: true
    if: success() || failure()
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        continue-on-error: true
        uses: actions/deploy-pages@v4

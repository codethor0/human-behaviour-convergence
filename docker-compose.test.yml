# SPDX-License-Identifier: PROPRIETARY
# Docker Compose configuration for E2E testing
# This file is used by CI to run comprehensive Docker-based tests

version: '3.8'

services:
  backend-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    environment:
      - PYTHONPATH=/app
      - CI=true
      - TESTING=true
      - CACHE_MAX_SIZE=10
      - CACHE_TTL_MINUTES=1
      - LOG_LEVEL=DEBUG
      - HBC_DB_PATH=/tmp/test_hbc.db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - test-network

  frontend-test:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    environment:
      - NEXT_PUBLIC_API_BASE=http://backend-test:8000
      - CI=true
    depends_on:
      backend-test:
        condition: service_healthy
    networks:
      - test-network

  api-tests:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        echo 'Waiting for backend to be ready...' &&
        timeout 60 sh -c 'until curl -f http://backend-test:8000/health; do sleep 2; done' &&
        echo 'Running API tests...' &&
        pytest tests/test_api_backend.py tests/test_forecasting_endpoints.py tests/test_live_endpoints.py tests/test_playground_endpoints.py -v --tb=short
      "
    depends_on:
      backend-test:
        condition: service_healthy
    environment:
      - PYTHONPATH=/app
      - API_BASE_URL=http://backend-test:8000
      - CI=true
    networks:
      - test-network

  connector-tests:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    volumes:
      - .:/app
    working_dir: /app
    command: pytest tests/test_connectors*.py tests/test_*_connector.py -v --tb=short
    environment:
      - PYTHONPATH=/app
      - CI=true
    networks:
      - test-network

  integration-tests:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    volumes:
      - .:/app
    working_dir: /app
    command: >
      sh -c "
        echo 'Waiting for backend to be ready...' &&
        timeout 60 sh -c 'until curl -f http://backend-test:8000/health; do sleep 2; done' &&
        echo 'Running integration tests...' &&
        pytest tests/test_connectors_integration.py -v --tb=short
      "
    depends_on:
      backend-test:
        condition: service_healthy
    environment:
      - PYTHONPATH=/app
      - API_BASE_URL=http://backend-test:8000
      - CI=true
    networks:
      - test-network

networks:
  test-network:
    driver: bridge

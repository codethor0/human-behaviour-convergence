<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Behavior Convergence Explorer</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <style>
      body {
        background: radial-gradient(circle at top, #0f172a, #020617 55%);
      }
    </style>
  </head>
  <body class="min-h-screen text-slate-100">
    <main class="mx-auto max-w-5xl px-6 py-12 space-y-12">
      <header class="space-y-4">
        <p class="inline-flex items-center rounded-full bg-slate-800/60 px-3 py-1 text-xs font-semibold uppercase tracking-wider text-cyan-300">
          Synthetic research preview
        </p>
        <h1 class="text-4xl font-bold tracking-tight sm:text-5xl">
          Behavior Convergence Explorer
        </h1>
        <p class="max-w-3xl text-lg text-slate-300">
          All outputs on this page are purely synthetic. Forecasts are generated
          deterministically from handcrafted signals to illustrate the API surface
          and ethical guardrails without exposing personal data.
        </p>
      </header>

      <section class="grid gap-10 lg:grid-cols-[2fr,3fr]">
        <div class="space-y-4">
          <h2 class="text-2xl font-semibold text-slate-100">
            Try a synthetic forecast
          </h2>
          <form
            id="forecast-form"
            class="space-y-4 rounded-xl border border-slate-700 bg-slate-900/70 p-6 shadow-lg shadow-black/30 backdrop-blur"
          >
            <div>
              <label for="region" class="block text-sm font-medium text-slate-200"
                >Region</label
              >
              <input
                id="region"
                name="region"
                type="text"
                inputmode="text"
                required
                value="us-midwest"
                class="mt-1 block w-full rounded-md border-slate-600 bg-slate-950/70 text-slate-100 placeholder-slate-500 shadow-sm focus:border-cyan-400 focus:ring-cyan-400"
                placeholder="e.g. us-midwest"
              />
            </div>

            <div>
              <label for="horizon" class="block text-sm font-medium text-slate-200"
                >Horizon (days)</label
              >
              <input
                id="horizon"
                name="horizon"
                type="number"
                min="1"
                max="30"
                value="7"
                required
                class="mt-1 block w-full rounded-md border-slate-600 bg-slate-950/70 text-slate-100 shadow-sm focus:border-cyan-400 focus:ring-cyan-400"
              />
              <p class="mt-1 text-xs text-slate-400">
                The API accepts horizons between 1 and 30 days.
              </p>
            </div>

            <fieldset>
              <legend class="block text-sm font-medium text-slate-200">
                Modalities
              </legend>
              <p class="mt-1 text-xs text-slate-400">
                Choose one or more synthetic data sources to weight the forecast.
              </p>
              <div
                class="mt-3 grid gap-2 rounded-lg border border-slate-700 bg-slate-950/50 p-3 sm:grid-cols-2"
              >
                <label class="inline-flex items-center gap-2">
                  <input
                    type="checkbox"
                    name="modalities"
                    value="satellite"
                    class="rounded border-slate-600 bg-slate-900 text-cyan-400 focus:ring-cyan-400"
                    checked
                  />
                  <span class="text-sm text-slate-200">Satellite imagery</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input
                    type="checkbox"
                    name="modalities"
                    value="mobility"
                    class="rounded border-slate-600 bg-slate-900 text-cyan-400 focus:ring-cyan-400"
                  />
                  <span class="text-sm text-slate-200">Mobility telemetry</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input
                    type="checkbox"
                    name="modalities"
                    value="social"
                    class="rounded border-slate-600 bg-slate-900 text-cyan-400 focus:ring-cyan-400"
                  />
                  <span class="text-sm text-slate-200">Social activity</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input
                    type="checkbox"
                    name="modalities"
                    value="environmental"
                    class="rounded border-slate-600 bg-slate-900 text-cyan-400 focus:ring-cyan-400"
                  />
                  <span class="text-sm text-slate-200">Environmental sensors</span>
                </label>
              </div>
            </fieldset>

            <button
              type="submit"
              class="inline-flex w-full items-center justify-center rounded-md bg-cyan-500 px-4 py-2 text-sm font-semibold text-slate-900 shadow transition hover:bg-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-300 focus:ring-offset-2 focus:ring-offset-slate-900"
            >
              Generate forecast
            </button>
            <p id="form-status" class="text-xs text-slate-400"></p>
          </form>

          <section
            id="forecast-output"
            class="space-y-4 rounded-xl border border-slate-700 bg-slate-900/60 p-6 shadow"
            aria-live="polite"
          >
            <h3 class="text-xl font-semibold text-slate-100">
              Forecast preview
            </h3>
            <div id="forecast-content" class="space-y-3 text-sm text-slate-200">
              <p class="text-slate-400">
                Submit the form to request a forecast. If the local API is not
                available, we will display a mocked response so you can explore the
                interface. All numbers remain synthetic.
              </p>
            </div>
          </section>
        </div>

        <div class="space-y-4">
          <h2 class="text-2xl font-semibold text-slate-100">
            Architecture snapshot
          </h2>
          <figure
            class="overflow-hidden rounded-2xl border border-slate-800 bg-slate-900/40 shadow-xl shadow-cyan-500/10"
          >
            <img
              src="../diagram/behaviour-convergence.svg"
              alt="Behavior Convergence architecture diagram"
              class="w-full"
            />
            <figcaption class="p-4 text-xs text-slate-400">
              Diagram rendered from the Mermaid source in <code>diagram/</code>.
              The Explorer serves as a companion UI for the FastAPI backend.
            </figcaption>
          </figure>
        </div>

        <div class="space-y-3" id="public-stats">
          <h2 class="text-2xl font-semibold text-slate-100">
            Live public data snapshot
          </h2>
          <div
            class="rounded-2xl border border-slate-800 bg-slate-900/50 p-4 text-sm text-slate-300 shadow-lg shadow-emerald-500/10"
          >
            <p id="public-stats-summary" class="text-slate-400">
              Loading latest snapshot…
            </p>
            <ul
              id="public-stats-list"
              class="mt-3 space-y-2 text-xs text-slate-400"
            ></ul>
          </div>
        </div>
      </section>
    </main>

    <script>
      const mockResponse = (payload) => ({
        region: payload.region,
        horizon: payload.horizon,
        modalities: payload.modalities,
        forecast: 0.73,
        confidence: 0.88,
        explanations: payload.modalities.length
          ? payload.modalities.map((m, idx) => `${m} contribution: ${0.44 + idx * 0.1}`)
          : ["baseline synthetic trend applied"],
        ethics: { synthetic: true, pii: false },
        _mocked: true,
      });

      const renderForecast = (data, container) => {
        const { region, horizon, modalities, forecast, confidence, explanations, ethics, _mocked } =
          data;
        container.innerHTML = `
          <div class="space-y-2">
            <p class="text-sm uppercase tracking-wide text-cyan-300">Synthetic forecast</p>
            <div class="flex flex-wrap gap-6 text-base">
              <div>
                <p class="text-xs text-slate-400">Region</p>
                <p class="font-semibold">${region}</p>
              </div>
              <div>
                <p class="text-xs text-slate-400">Horizon</p>
                <p class="font-semibold">${horizon} day(s)</p>
              </div>
              <div>
                <p class="text-xs text-slate-400">Modalities</p>
                <p class="font-semibold">${modalities.length ? modalities.join(", ") : "baseline"}</p>
              </div>
            </div>
            <div class="grid gap-4 rounded-lg border border-slate-800 bg-slate-950/60 p-4 sm:grid-cols-2">
              <div>
                <p class="text-xs text-slate-400">Forecast index</p>
                <p class="text-3xl font-bold text-cyan-300">${forecast}</p>
              </div>
              <div>
                <p class="text-xs text-slate-400">Confidence</p>
                <p class="text-3xl font-bold text-emerald-300">${confidence}</p>
              </div>
            </div>
            <div>
              <p class="text-xs text-slate-400">Modal contribution notes</p>
              <ul class="mt-1 list-disc space-y-1 pl-5 text-sm text-slate-200">
                ${explanations.map((text) => `<li>${text}</li>`).join("")}
              </ul>
            </div>
            <div class="rounded-lg border border-slate-800 bg-slate-950/60 p-4 text-xs text-slate-400">
              Ethics: synthetic=${ethics.synthetic}, pii=${ethics.pii}. Outputs never reference real individuals.
            </div>
            ${
              _mocked
                ? '<p class="text-xs text-amber-300">Displayed using mocked data (API unreachable).</p>'
                : ""
            }
          </div>
        `;
      };

      const form = document.getElementById("forecast-form");
      const status = document.getElementById("form-status");
      const content = document.getElementById("forecast-content");

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        status.textContent = "Requesting forecast…";

        const formData = new FormData(form);
        const payload = {
          region: formData.get("region").trim(),
          horizon: Number(formData.get("horizon")),
          modalities: formData.getAll("modalities"),
        };

        try {
          const response = await fetch("/api/forecast", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            throw new Error(`API responded with ${response.status}`);
          }

          const data = await response.json();
          renderForecast(data, content);
          status.textContent = "Served by local API.";
        } catch (error) {
          console.warn("Falling back to mocked response:", error);
          const data = mockResponse(payload);
          renderForecast(data, content);
          status.textContent =
            "Local API was unreachable. Displaying mocked synthetic response.";
        }
      });

      async function loadPublicStats() {
        const summaryEl = document.getElementById("public-stats-summary");
        const listEl = document.getElementById("public-stats-list");
        if (!summaryEl || !listEl) return;

        try {
          const response = await fetch("/api/public/stats", { cache: "no-store" });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const data = await response.json();

          if (!data.available) {
            summaryEl.textContent =
              (data.errors && data.errors.snapshot) ||
              "No live snapshot found. Run `hbc-cli sync-public-data --apply` to populate data/public/latest.";
            listEl.innerHTML = "";
            return;
          }

          const updated = data.generated_at
            ? new Date(data.generated_at).toLocaleString()
            : "n/a";
          summaryEl.textContent = `Date: ${data.date || "unknown"} • Updated ${updated}`;
          listEl.innerHTML = "";

          const labelMap = {
            wiki: "Wikipedia pageviews",
            osm: "OSM changesets",
            firms: "NASA FIRMS fires",
          };

          Object.entries(data.sources || {}).forEach(([key, info]) => {
            const label = labelMap[key] || key.toUpperCase();
            const li = document.createElement("li");
            if (info.error) {
              li.textContent = `${label}: error (${info.error})`;
              li.style.color = "#fca5a5";
            } else {
              li.textContent = `${label}: ${Number(info.rows || 0).toLocaleString()} rows`;
            }
            listEl.appendChild(li);
          });
        } catch (error) {
          summaryEl.textContent = `Unable to load snapshot: ${error.message}`;
          listEl.innerHTML = "";
        }
      }

      loadPublicStats();
    </script>
  </body>
</html>
